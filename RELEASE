#!/bin/sh

set -e

suppress=NO

git status 2> /dev/null \
    |  egrep 'Changes not staged for commit|Changes to be committed' > /dev/null \
    && suppress=SUPPRESS

if [ $suppress = SUPPRESS ]; then
    echo
    echo '`git status'"'"' reports changed files.'
    echo 'This script will continue, but will not build a final .tar.gz file.'
    echo
fi

echo 'Version number is:'
echo
cat VERSION || ( echo "VERSION file doesn't exist; aborting release" ; exit 1 )
echo

release=./beluga-`cat VERSION`

echo 'Release directory name is:'
echo
echo '    '$release
echo

if [ -e $release ]; then
    echo Release directory "$release" already exists.
    exit 1
fi

mkdir $release

echo 'Copying files in root'
cp -a \
    INSTALL \
    OMakefile \
    OMakeroot \
    AUTHORS \
    COPYRIGHT \
    LICENSE \
    VERSION \
    $release

mkdir $release/bin

echo 'Copying src'
cp -a \
    src \
    $release

echo 'Copying tools'
cp -a \
    tools \
    $release

echo 'Copying examples examples-twelf'
cp -a \
    examples \
    examples-twelf \
    $release

cd $release
echo Deleting useless files:
useless=$(find . -print | egrep '~|.DS_Store' || true)
echo rm -rf $useless
rm -rf $useless

# Remove examples not yet ready for public consumption
echo rm -rf examples/{notworking,cfg,beluga}
rm -rf examples/{notworking,cfg,beluga}

echo "Copying $release to $release-sandbox"
cd ..
if [ -e $release-sandbox ]; then
    echo Release sandbox directory "$release-sandbox" already exists.
    exit 1
fi
cp -a $release $release-sandbox

echo 'Building (bytecode) in-tree first, for testing'
omake clean
omake || ( echo 'omake failed; aborting release' ; exit 1 )

echo 'Running TEST (bytecode)'
./TEST || ( echo 'TEST failed; aborting release' ; exit 1 )

echo 'Building (native) in-tree first, for testing'
omake clean
omake NATIVE_ENABLED=true clean
omake NATIVE_ENABLED=true || ( echo 'native omake failed; aborting release' ; exit 1 )

echo 'Running TEST (native)'
./TEST || ( echo 'TEST failed; aborting release' ; exit 1 )

cd $release-sandbox

echo 'Building (bytecode) in release directory'
omake || ( echo 'omake failed; aborting release' ; exit 1 )

echo 'Building (native) in release directory'
omake clean
omake NATIVE_ENABLED=true clean
omake NATIVE_ENABLED=true || ( echo 'native omake failed; aborting release' ; exit 1 )

cd ..
echo 'Leaving '$release-sandbox' around if you want to test further'

if [ $suppress = SUPPRESS ]; then
    echo 'There are uncommitted changes.  Please commit them and run RELEASE again.'
    exit 3
fi

sleep 1
echo 'Building archive' $release.tar.gz
tar zcf $release.tar.gz $release || ( echo 'tar failed' ; exit 1 )
echo
ls -l $release.tar.gz
echo
echo "Release built.  Don't forget to "'`'"git push' if needed."
