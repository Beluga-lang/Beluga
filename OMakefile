# -*- coding: utf-8; indent-tabs-mode: nil; -*-

# Use ocamlfind to manage library linking
USE_OCAMLFIND = true

# Set up the ocamlfind flags
OCAMLFINDFLAGS = -syntax camlp4o

# The ocamlfind packages we use
OCAMLPACKS[] =
        camlp4
        extlib
        oUnit
        ulex

# Compile with debugging options?  This enables:
#
# 1. Pattern match failure warnings
# 2. Debugging information in compiled code (-g)
# 3. Profiling information in compiled code (-p)
OCAMLFLAGS = $(if $(DEBUG), -w Ae  -warn-error Ap -g \
                          , -w Aep -warn-error A)

# Flags to pass to the native-code compiler
# Explanation:
#       -noassert       (turn off assertions)
#       -inline 100     (aggressive inlining)
OCAMLOPTFLAGS  = -noassert -inline 100
OCAMLOPTFLAGS += $(if $(DEBUG), -p)

# Compile to byte code?
BYTE_ENABLED   = false

# Compile to native code?
NATIVE_ENABLED = true

# Declare a phony clean target
.PHONY: core clean frontend interpreter test

# Include the src subdirectory
.SUBDIRS: src

.DEFAULT: .PHONY/src/.DEFAULT :effects: build
        $(if $(not $(file-exists build)),             \
          $(mkdir build))                             \
        $(if $(not $(file-exists build/interpreter)), \
          $(symlink src/tools/interpreter/interpreter, build/interpreter))

clean: .PHONY/src/clean
        $(if $(file-exists build), $(rmdir -r build))