#!/bin/bash

usage() {
    echo "Usage: $0 [test-options] -- [beluga-options]"
    echo
    echo "Synopsis: test harness for Beluga."
    echo
    echo "Notes:"
    echo "    - Pure LF signatures are in files sources.cfg."
    echo "    - Proofs written in Beluga are in test.cfg."
    echo "    - Files ending in .bel contain Beluga programs."
    echo "    - If a test.cfg file is found in a subdirectory, only it will be tested."
    echo "    - If no test.cfg file is found, all .bel files in the subdirectory"
    echo "      will be tested."
    echo "    - To inhibit testing .bel files, put an empty test.cfg in that directory."
}

echo "Parameters for this run (override as necessary using environment variables):"
echo

# Path to the Beluga source distribution.
echo -e "\t" BELUGADIR=${BELUGADIR:=$(dirname $0)}

# Set $EXE to the executable to test.
echo -e "\t" EXE=${EXE:=$BELUGADIR/bin/interpreter}

# Test scripts.
echo -e "\t" TESTDIR=${TESTDIR:=$BELUGADIR/examples}

echo

# Find test cases.
test_cases() {
    for dir in $(find $TESTDIR -type d)
    do
	[[ -f $dir/sources.cfg ]] && echo $dir/sources.cfg
	if [[ -f $dir/test.cfg ]]
	then
	    echo $dir/test.cfg
	else
	    find $dir/ -maxdepth 1 -name '*.bel' -type f
	fi
    done
}

sort_cases() {
    cases=($(</dev/stdin))
    cases_cfg=($(find ${cases[@]} -name '*.cfg'))
    cases_bel=($(find ${cases[@]} -name '*.bel'))
    # Need to count lines explicitly for compatibily with BSD head.
    echo ${cases_bel[@]} | xargs wc -c | head -n ${#cases_bel[@]} | sort -n | awk '{print $2}'
    find ${cases_cfg[@]}
}

n=0
success=0
fail=0
timeout=0

ulimit -t 2

for i in $(test_cases | sort_cases)
do
    n=$((n+1))
    echo -n "** TEST $n: $i ... "

    result=$($EXE -noprint $* $i 2>&1)
    exit_code=$?
    if [[ $exit_code -eq 0 ]]
    then
	echo "done"
	success=$((success+1))
    elif [[ $exit_code -eq 137 ]]
    then
	echo "TIMEOUT!"
	timeout=$((timeout+1))
    else
	echo "FAIL!"
	echo "$result"
	fail=$((fail+1))
    fi
done

echo
echo Successes: $success
echo Failures: $fail
echo Timeouts: $timeout
echo Total: $n

echo
times

# If not all tests succeeded then exit with non-zero status.
[[ $success -eq $n ]] || exit 1
